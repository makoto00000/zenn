---
title: "Sessionã¨Cookieã®å­¦ç¿’ãŒã¦ã‚‰CSRFå¯¾ç­–ã‚’æ‰‹å‹•ã§ã‚„ã£ã¦ã¿ãŸ"
emoji: "ğŸª"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Nextjs", "Rails", "Cookie"]
published: true
---

## æ¦‚è¦

ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ : Next.js
ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ : Ruby on Rails

ã“ã®çµ„ã¿åˆã‚ã›ã§ã€Cookieã‚’Railsã§ç™ºè¡Œã—ã¦ã€ãã‚Œã‚’Next.jså´ã§æ‰±ã†ã¨ã„ã†ã‚¤ãƒ¡ãƒ¼ã‚¸ãŒå…¨ãæ²¸ãã¾ã›ã‚“ã§ã—ãŸã€‚

å­¦ç¿’ã®ãŸã‚ã«ã€å®Ÿéš›ã«ã„ã‚ã„ã‚ã‚¤ã‚¸ã£ã¦ã¿ã¦ã€ã‚ˆã†ã‚„ãç†è§£ã§ããŸã®ã§å…±æœ‰ã—ã¾ã™ã€‚

## æœ¬è¨˜äº‹ã‚’èª­ã‚€ã“ã¨ã§

- Next.js <=> Railsé–“ã§Cookieã‚’ã‚„ã‚Šå–ã‚Šã®æ–¹æ³•ãŒã‚ã‹ã‚‹
- Railsã§Cookieã€Sessionã‚’æ‰±ã†æ–¹æ³•ãŒã‚ã‹ã‚‹
- CSRFå¯¾ç­–ã«ã¤ã„ã¦ç†è§£ã§ãã‚‹
- ã‚»ãƒƒã‚·ãƒ§ãƒ³å›ºå®šåŒ–æ”»æ’ƒã«ã¤ã„ã¦ç†è§£ã§ãã‚‹

## Railsç’°å¢ƒæ§‹ç¯‰

ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§apiãƒ¢ãƒ¼ãƒ‰ã§Railsã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ§‹ç¯‰

```shell
rails new hogehoge --api
```

```shell
rails db:create
```

```shell
rails g model User name:string email:string password:string password_digest:string
```

```shell
rails db:migrate
```

Next.jsã®ãƒãƒ¼ãƒˆã¨ç«¶åˆã—ã¦ã—ã¾ã†ã®ã§ã€3001ã§èµ·å‹•ã™ã‚‹ã“ã¨ã¨ã™ã‚‹ã€‚

```shell
rails s -p 3001
```

Cookieã€Sessionã‚’æ‰±ã†ãŸã‚ã«ä»¥ä¸‹ã®è¨­å®šãŒå¿…è¦

```ruby:config/application.rb
    # Cookieã‚’ä½¿ã†
    # CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ç”¨ã™ã‚‹ã®ã«ã‚‚å¿…è¦ form_authenticity_tokenãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆ
    # â†’ _csrf_tokenã¨ã„ã†keyã§sessionã«ä¿å­˜ã—ã¦ã„ã‚‹
    config.middleware.use ActionDispatch::Cookies
    
    # ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½¿ã†
    # Sessionã«å€¤ã‚’ã‚»ãƒƒãƒˆã—ã‚ˆã†ã¨ã™ã‚‹ã¨ã€ä»¥ä¸‹ãŒç™ºç”Ÿ
    # ActionDispatch::Request::Session::DisabledSessionError: Your application has sessions disabled. To write to the session you must first configure a session store
    config.middleware.use ActionDispatch::Session::CookieStore

    # ãƒ•ãƒ­ãƒ³ãƒˆã¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§ãƒ‰ãƒ¡ã‚¤ãƒ³åãŒç•°ãªã‚‹å ´åˆï¼ˆæœ¬ç•ªç’°å¢ƒã®ãŸã‚ï¼‰
    # https://www.hogehoge.com ã¨ https://api.hogehoge.com ã®ã‚ˆã†ãªå ´åˆ
    # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯laxã«ãªã£ã¦ã„ã‚‹ â†’ GETãƒ¡ã‚½ãƒƒãƒ‰ã¯è¨±å¯ã—ã¦ã€POSTãƒ¡ã‚½ãƒƒãƒ‰ã§ã¯Cookieã‚’é€ã‚Œãªã„
    # :noneã§ã¯ãªã„ã“ã¨ã«æ³¨æ„
    config.action_dispatch.cookies_same_site_protection = nil
```

## Next.jsç’°å¢ƒæ§‹ç¯‰

1. ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§Next.jsã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ§‹ç¯‰

```shell
npx create-next-app@latest hogehoge --ts
```

2. `global.css`ã®ä¸­èº«ã‚’å‰Šé™¤

3. page.module.cssã®ä¸­èº«ã‚’ä»¥ä¸‹ã«æ›¸ãæ›ãˆ

:::details page.module.css

```css:page.module.css
   .main {
     padding: 50px;
   }

   .container {
     display: flex;
     flex-direction: column;
     align-items: center;
     justify-content: center;
     background: #ddd;
     margin-bottom: 30px;
     padding: 50px;
     border-radius: 10px;
   }

   .title {
     text-align: center;
     color: #141414;
     margin: 0;
     margin-bottom: 30px;
   }

   .buttons {
     width: 100%;
     display: flex;
     justify-content: space-around;
     align-items: center;
   }

   .button {
     background-color: #141414;
     border: 1px solid rgba(54, 54, 54, 0.6);
     font-weight: 600;
     position: relative;
     outline: none;
     border-radius: 10px;
     display: flex;
     justify-content: center;
     align-items: center;
     cursor: pointer;
     opacity: 1;
     color: #fff;
     padding: 10px;
   }

   .label {
     margin-bottom: 5px;
   }

   .input {
     font-size: 1em;
     padding: 5px;
     border: 1px solid #cecece;
     border-radius: 5px;
     box-sizing: border-box;
     margin-bottom: 10px;
   }

   .userContainer {
     display: flex;
     flex-direction: column;
     align-items: center;
     justify-content: center;
   }

   .user {
     font-size: 20px;
     font-weight: bold;
     margin-bottom: 20px;
   }

   .notLogin {
     font-size: 20px;
     font-weight: bold;
   }
```

:::

4. page.tsxã‚’æ›¸ãæ›ãˆ

:::details page.tsx

```tsx:page.tsx
"use client";

import styles from "./page.module.css";
import { useState, useEffect, FormEvent, useRef } from "react";

type User = {
  name: string;
  email: string;
};
export default function Home() {
  const [csrfToken, setCsrfToken] = useState<string | null>(null);
  const [user, setUser] = useState<User | null>(null);
  const signupFormRef = useRef<HTMLFormElement>(null);
  const loginFormRef = useRef<HTMLFormElement>(null);

  const getCsrfToken = async () => {
  
  };

  const setSession = async () => {

  };
  const getSession = async () => {

  };

  const getUser = async () => {

  };

  const signup = async (formData: Iterable<readonly [PropertyKey, any]>) => {

  };

  const login = async (formData: Iterable<readonly [PropertyKey, any]>) => {

  };

  const logout = async () => {

  };

  async function handleSignup(e: FormEvent<HTMLFormElement>) {

  }

  async function handleLogin(e: FormEvent<HTMLFormElement>) {

  }

  return (
    <main className={styles.main}>
      <div className={styles.container}>
        <h2 className={styles.title}>Session</h2>
        <div className={styles.buttons}>
          <button className={styles.button} onClick={() => getCsrfToken()}>
            CSRFãƒˆãƒ¼ã‚¯ãƒ³ç™ºè¡Œ
          </button>
          <button className={styles.button} onClick={() => setSession()}>
            ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ã‚»ãƒƒãƒˆ
          </button>
          <button className={styles.button} onClick={() => getSession()}>
            ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å–å¾—
          </button>
        </div>
      </div>

      <form
        className={styles.container}
        onSubmit={handleSignup}
        ref={signupFormRef}
      >
        <h2 className={styles.title}>Sign Up</h2>
        <label className={styles.label}>Name:</label>
        <input
          className={styles.input}
          type="text"
          name="name"
          autoComplete="name"
        />
        <label className={styles.label}>Email:</label>
        <input
          className={styles.input}
          type="email"
          name="email"
          autoComplete="email"
        />
        <label className={styles.label}>Password:</label>
        <input className={styles.input} type="password" name="password" />
        <label className={styles.label}>Confirm Password:</label>
        <input
          className={styles.input}
          type="password"
          name="password_confirmation"
        />
        <button className={styles.button} type="submit">
          Submit
        </button>
      </form>
      <form
        className={styles.container}
        onSubmit={handleLogin}
        ref={loginFormRef}
      >
        <h2 className={styles.title}>Login</h2>
        <label className={styles.label}>Email:</label>
        <input
          className={styles.input}
          type="email"
          name="email"
          autoComplete="email"
        />
        <label className={styles.label}>Password:</label>
        <input className={styles.input} type="password" name="password" />
        <button className={styles.button} type="submit">
          Submit
        </button>
      </form>
      <div className={styles.container}>
        <h2 className={styles.title}>ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±</h2>
        {user ? (
          <div className={styles.userContainer}>
            <label className={styles.label}>Name:</label>
            <div className={styles.user}>{user.name}</div>
            <label className={styles.label}>Email:</label>
            <div className={styles.user}>{user.email}</div>
          </div>
        ) : (
          <div className={styles.notLogin}>ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„</div>
        )}
        {user ? (
          <button className={styles.button} onClick={() => logout()}>
            Logout
          </button>
        ) : null}
      </div>
    </main>
  );
}
```

:::

ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ã‚¢ãƒ—ãƒªã‚’ç«‹ã¡ä¸Šã’ã‚‹ã€‚

```shell
npm run dev
```

ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®è¨­å®šã®ã¾ã¾ãªã‚‰ã€ãƒãƒ¼ãƒˆ3000ã§èµ·å‹•ã™ã‚‹ã®ã§ã€<http://localhost:3000>ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã€ä»¥ä¸‹ã®ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚Œã°OKã€‚

![cookie_practice](https://github.com/makoto00000/cookie_practice/assets/65654634/e308e2f3-a277-473f-b378-a4dca9c688c5)

## CSRFå¯¾ç­–

### CSRFï¼ˆã‚¯ãƒ­ã‚¹ã‚µã‚¤ãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ•ã‚©ãƒ¼ã‚¸ã‚§ãƒªï¼‰ã¨ã¯

![å®‰å…¨ãªã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆã®ä½œã‚Šæ–¹ - 1.6 CSRFï¼ˆã‚¯ãƒ­ã‚¹ã‚µã‚¤ãƒˆãƒ»ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ»ãƒ•ã‚©ãƒ¼ã‚¸ã‚§ãƒªï¼‰](https://www.ipa.go.jp/security/vuln/websecurity/ug65p900000196v0-img/ug65p9000001grm3.png)
*[IPAç‹¬ç«‹è¡Œæ”¿æ³•äººæƒ…å ±å‡¦ç†æ¨é€²æ©Ÿæ§‹- å®‰å…¨ãªã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆã®ä½œã‚Šæ–¹ - 1.6 CSRFï¼ˆã‚¯ãƒ­ã‚¹ã‚µã‚¤ãƒˆãƒ»ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ»ãƒ•ã‚©ãƒ¼ã‚¸ã‚§ãƒªï¼‰](https://www.ipa.go.jp/security/vuln/websecurity/csrf.html)*

ãƒ­ã‚°ã‚¤ãƒ³èªè¨¼ã®ä»•çµ„ã¿ã¨ã—ã¦ã€å¤šãã®ã‚µãƒ¼ãƒ“ã‚¹ã§ã¯ã€ãƒ–ãƒ©ã‚¦ã‚¶ã®Cookieã«tokenã‚’ã‚»ãƒƒãƒˆã—ã¦ã„ã‚‹ã‚‚ã®ã¨ã—ã¦ã€CSRFã¯ä»¥ä¸‹ã®ã‚ˆã†ãªæµã‚Œã§èµ·ã“ã£ã¦ã—ã¾ã„ã¾ã™ã€‚

1. tokenã‚’ã‚»ãƒƒãƒˆã—ãŸçŠ¶æ…‹ã§ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒæ¥ãŸã¨ãã«ã€ã‚µãƒ¼ãƒãƒ¼å´ã¯ã“ã®tokenã‚’è¦‹ã¦ã€Œãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã®Aã•ã‚“ã‹ã€ã¨åˆ¤æ–­ã—ã¦ã„ã‚‹ã€‚

2. ä¾‹ãˆã°æ²ç¤ºæ¿ã¸ã®æ›¸ãè¾¼ã¿ã‚’è¡Œã†ã¨ãã«ã€POSTãƒ¡ã‚½ãƒƒãƒ‰ã§ã‚µãƒ¼ãƒãƒ¼ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚‹ã€‚

3. ã“ã‚ŒãŒæ­£è¦ã®æ²ç¤ºæ¿ã‹ã‚‰é€ã‚‰ã‚Œã‚‹ãªã‚‰å•é¡Œãªã„ãŒã€ãƒªãƒ³ã‚¯ã‚’è¸ã¾ã›ã¦POSTã™ã‚‹ã“ã¨ã‚‚ã§ãã¦ã—ã¾ã†ã€‚

4. ã‚µãƒ¼ãƒãƒ¼å´ã‹ã‚‰ã¯ã€æ­£è¦ã®æ›¸ãè¾¼ã¿ãªã®ã‹ã€ç¬¬3è€…ãŒç”¨æ„ã—ãŸãƒªãƒ³ã‚¯ã‚’è¸ã‚“ã ã“ã¨ã§é€ã‚‰ã‚ŒãŸæ›¸ãè¾¼ã¿ãªã®ã‹ã¯è­˜åˆ¥ã§ããªã„ã®ã§ã€Aã•ã‚“ãŒæ›¸ãè¾¼ã‚“ã ã“ã¨ã«ãªã£ã¦ã—ã¾ã†ã€‚

ã“ã®æ‰‹å£ã§èµ·ã“ã£ãŸäº‹ä»¶ã¨ã—ã¦ã€[æ¨ªæµœCSRFäº‹ä»¶](https://xtech.nikkei.com/it/article/COLUMN/20130218/456763/)ãŒæœ‰åã§ã™ã€‚
çŠ¯è¡Œäºˆå‘Šã‚’è¡Œã£ãŸã¨ã—ã¦ã€æ›¸ãè¾¼ã‚“ã§ã„ãªã„äººãŒèª¤èªé€®æ•ã•ã‚Œã¾ã—ãŸã€‚

### CSRFå¯¾ç­–æ–¹æ³•

è§£æ±ºæ–¹æ³•ã¨ã—ã¦ã€POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒæ­£è¦ã®ã‚‚ã®ã‹ã©ã†ã‹ã‚’ã€åŒºåˆ¥ã§ãã‚Œã°ã„ã„ã‚ã‘ã§ã™ã€‚

ãã—ã¦ãã‚Œã¯ã€ä»¥ä¸‹ã®æµã‚Œã§è¡Œãˆã°å®Ÿç¾ã—ãã†ã§ã™ã€‚

1. POSTé€ä¿¡ã™ã‚‹å‰ã«ã€æ­£è¦ã®æ²ç¤ºæ¿ã‹ã‚‰ã‚µãƒ¼ãƒãƒ¼ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚Štokenã‚’ç™ºè¡Œã—ã¦ãŠãã€‚
2. ã“ã®tokenã‚’POSTé€ä¿¡æ™‚ã«ç¢ºèªã™ã‚‹ã€‚
3. ç¢ºèªãŒã§ããŸã¨ãã ã‘ã€POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘ä»˜ã‘ã‚‹ã€‚

ã“ã®ã¨ãã®tokenã‚’ã€CSRFãƒˆãƒ¼ã‚¯ãƒ³ã¨å‘¼ã‚“ã ã‚Šã—ã¾ã™ã€‚

### Railsã®è¨­å®š

#### CSRFã®æ¤œè¨¼ã‚’ã™ã‚‹è¨­å®š

`application_controller.rb`ã«ä»¥ä¸‹ã‚’è¨˜è¿°

```ruby:app/controllers/application_controller.rb
class ApplicationController < ActionController::API

  # CSRFå¯¾ç­–ã‚’ã™ã‚‹ãŸã‚
  include ActionController::RequestForgeryProtection
  protect_from_forgery with: :exception

end

```

ã“ã‚Œã‚’æ›¸ã„ã¦ãŠãã¨ã€GETä»¥å¤–ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒæ¥ãŸã¨ãã«ã€CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ¤œè¨¼ã™ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
æ¤œè¨¼ã«å¤±æ•—ã™ã‚‹ã¨ã€`ActionController::InvalidAuthenticityToken`ã®ä¾‹å¤–ãŒç™ºç”Ÿã™ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

#### corsã‚’è¨­å®š

csrfãƒˆãƒ¼ã‚¯ãƒ³ã¯cookieã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚ã“ã‚Œã‚’Railså´ã«é€ã‚‹ãŸã‚ã«ã€æ˜ç¤ºçš„ã«è¨­å®šãŒå¿…è¦ã§ã™ã€‚`cors.rb`ãƒ•ã‚¡ã‚¤ãƒ«ã«`credentials: true`ã¨ã™ã‚‹ã“ã¨ã§ã€Cookieã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å«ã‚ã‚‹ã“ã¨ã‚’è¨±å¯ã—ã¾ã™ã€‚

```ruby:config/initializers/cors.rb
Rails.application.config.middleware.insert_before 0, Rack::Cors do
  allow do
    origins 'http://localhost:3000'
    resource '/api/v1/*',
      headers: :any,
      methods: [:get, :post, :put, :patch, :delete, :options, :head],
      expose: ['X-CSRF-Token'],
      credentials: true
  end
end

```

:::message
Next.jsã¨Railsã§ã¯ãƒãƒ¼ãƒˆç•ªå·ãŒç•°ãªã‚‹ã®ã§ã€ã©ã¡ã‚‰ã«ã›ã‚ˆã€corsè¨­å®šãŒå¿…è¦ã§ã™ã€‚
:::

#### ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã®è¨­å®š

sessionsã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã‚’ä½œæˆ

```shell
rails g controller API::V1::Sessions
```

```ruby:app/controllers/api/v1/sessions_controller.rb
  def set_csrf_token
    render json: { authenticity_token: form_authenticity_token }, status: :ok
  end
```

```ruby:config/routes.rb
Rails.application.routes.draw do
  namespace :api do
    namespace :v1 do
      get "csrf", to: "sessions#set_csrf_token"
    end
  end
end
```

ã“ã‚Œã§ã€`http://localhost:3001`ã«GETãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚‹ã“ã¨ã§CSRFãƒˆãƒ¼ã‚¯ãƒ³ãŒç™ºè¡Œã•ã‚Œã¾ã™ã€‚

:::details ãã®ä»–ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ãªã©

```ruby:app/controllers/api/v1/sessions_controller.rb
class Api::V1::SessionsController < ApplicationController

  def set_csrf_token
    render json: { authenticity_token: form_authenticity_token }, status: :ok
  end

  def set_session
    session[:test] = "test_session"
    cookies[:test] = {
      value: "test_cookie",
      same_site: :none,
      secure: true,
      http_only: true,
    }
    render json: {session: session, cookie: cookies}, status: :ok
  end
  
  def get_session
    render json: {session: session, cookies: cookies}, status: :ok
  end

  def login
    @user = User.find_by(email: params[:session][:email].downcase)
    if @user&.authenticate(params[:session][:password])
      session[:user_id] = @user.id
      render json: {user: @user}, status: :ok
    else
      render json: {error: @user.error}, status: :unprocessable_entity
    end
  end

  def logout
    reset_session
    render json: {}, status: :ok
  end

end

```

```shell
rails g controller API::V1::Users
```

```ruby:app/controllers/api/v1/users_controller.rb
class Api::V1::UsersController < ApplicationController
  def create
    @user = User.new(user_params)
    if @user.save
      session[:user_id] = @user.id
      render json: {user: @user}, status: :ok
    else
      render json: {error: @user.error}, status: :unprocessable_entity
    end
  end

  def current_user
    user_id = session[:user_id]
    @user = User.find_by(id: user_id)
    if @user
      render json: {user: @user}, status: :ok
    else
      render json: {user: nil}, status: :ok
    end
  end

  private
  def user_params
    params.require(:user).permit(:name, :email, :password, :password_confirmation)
  end
end
```

```ruby:app/models/user.rb
class User < ApplicationRecord
  has_secure_password
end
```

```ruby:config/routes.rb
Rails.application.routes.draw do
  namespace :api do
    namespace :v1 do
      get "csrf", to: "sessions#set_csrf_token"
      post "session", to: "sessions#set_session"
      get "session", to: "sessions#get_session"
      post "signup", to: "users#create"
      post "login", to: "sessions#login"
      delete "logout", to: "sessions#logout"
      get "user", to: "users#current_user"
      post "cookie", to: "sessions#post_cookie"
    end
  end
end
```

:::

### Next.jsã®è¨­å®š

#### CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—

```tsx:page.tsx
  const getCsrfToken = async () => {
    const res = await fetch("http://localhost:3001/api/v1/csrf", {
      // sessionã‚’ä½¿ã†ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å¿…è¦
      credentials: "include", // CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’sessionã«å…¥ã‚Œã‚‹ãŸã‚ã«å¿…è¦
      method: "GET",
      headers: {
        "Content-Type": "application/json",
      },
    });
    const data = await res.json();
    console.log(data.authenticity_token);
    setCsrfToken(data.authenticity_token);
  };
```

ã“ã‚Œã§ã€CSRFãƒˆãƒ¼ã‚¯ãƒ³ç™ºè¡Œãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨CSRFãƒˆãƒ¼ã‚¯ãƒ³ãŒç™ºè¡Œã•ã‚Œã¾ã™ã€‚ã©ã“ã«ã‚ã‚‹ã‹ã¨ã„ã†ã¨ã€ãƒ–ãƒ©ã‚¦ã‚¶ã®Cookieã«ä¿å­˜ã•ã‚Œã¦ã„ã¾ã™ã€‚

chromeã§ã‚ã‚Œã°ã€å³ã‚¯ãƒªãƒƒã‚¯â†’æ¤œè¨¼â†’ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³â†’Cookieâ†’localhost:3000ã§ã€ä»¥ä¸‹ã®ã‚ˆã†ã«`_session_id`ãŒã‚»ãƒƒãƒˆã•ã‚Œã¦ã„ã‚Œã°OKã€‚

![cookie](https://github.com/makoto00000/cookie_practice/assets/65654634/558cb978-1a35-4b96-8efd-57df9e8642c5)

ç´°ã‹ãè¨€ãˆã°ã€CSRFãƒˆãƒ¼ã‚¯ãƒ³ã¯Sessionã«ä¿å­˜ã•ã‚Œã¦ã„ã¾ã™ã€‚ã—ã‹ã—Railsã¯Sessionã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã®Cookieã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ä¿å­˜ã™ã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã®ã§ã€ã“ã®ã‚ˆã†ã«_session_idã¨ã„ã†åå‰ã®CookieãŒä¿å­˜ã•ã‚Œã‚‹ã®ã§ã™ã€‚

CSRFãƒˆãƒ¼ã‚¯ãƒ³ã¯æš—å·åŒ–ã•ã‚Œã¦ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€å€¤ã ã‘ã‚’è¦‹ã¦ã‚‚åˆ†ã‹ã‚Šã¾ã›ã‚“ãŒã€Railsã«æ¸¡ã—ãŸã¨ãã«å¾©å·åŒ–ã—ã¦ãã‚Œã‚‹ã®ã§å•é¡Œã‚ã‚Šã¾ã›ã‚“ã€‚

:::message
ãŸã ã—ã€ã“ã®Cookieãã®ã‚‚ã®ãŒå¥ªã‚ã‚Œã¦ã—ã¾ã£ãŸã‚‰æ„å‘³ãŒã‚ã‚Šã¾ã›ã‚“ã€‚

- HttpOnlyå±æ€§: JavaScriptã§èª­ã¿å–ã‚Œãªã„ã‚ˆã†ã«ã™ã‚‹
- Secureå±æ€§: httpsé€šä¿¡ã®ã¨ãã®ã¿Cookieã‚’é€ä¿¡ã™ã‚‹

ã“ã®ï¼’ã¤ãŒtrueã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ãŒæ™®é€šã¯ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§trueã«ãªã£ã¦ã„ã‚‹ã®ã§å•é¡Œã‚ã‚Šã¾ã›ã‚“ã€‚ãŸã ã—Secureå±æ€§ã«ã¯ãƒã‚§ãƒƒã‚¯ãŒã¤ã„ã¦ã„ãªã„ã¨æ€ã„ã¾ã™ã€‚ã“ã‚Œã¯ã€é–‹ç™ºç’°å¢ƒã ã‹ã‚‰ã§ã€æœ¬ç•ªç’°å¢ƒã§ã‚ã‚Œã°ãƒã‚§ãƒƒã‚¯ãŒã¤ã„ã¦ã„ã‚‹ã¯ãšã§ã™ã€‚

ãã‚Œã§ã‚‚ç›—ã¾ã‚Œã‚‹ãƒªã‚¹ã‚¯ãŒå®Œå…¨ã«æ¶ˆãˆã‚‹ã‚ã‘ã§ã¯ãªãã€redisã‚„activerecord-session_storeã‚’ä½¿ã£ã¦ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§ç®¡ç†ã—ãŸã‚Šã€æœŸé™ã‚’è¨­å®šã—ã¦ãŠãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
:::

#### ãã®ä»–é–¢æ•°ã‚’å®šç¾©

```tsx:page.tsx
useEffect(() => {
    const handleGetUser = async () => {
      await getUser();
    };
    try {
      handleGetUser();
    } catch (error) {
      console.error(error);
    }
  }, []);

  const getCsrfToken = async () => {
    const res = await fetch("http://localhost:3002/api/v1/csrf", {
      // sessionã‚’ä½¿ã†ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å¿…è¦
      credentials: "include", // CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’sessionã«å…¥ã‚Œã‚‹ãŸã‚ã«å¿…è¦
      method: "GET",
      headers: {
        "Content-Type": "application/json",
      },
    });
    const data = await res.json();
    console.log(data.authenticity_token);
    setCsrfToken(data.authenticity_token);
  };

  const setSession = async () => {
    const res = await fetch("http://localhost:3002/api/v1/session", {
      credentials: "include", // CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ¸¡ã™ãŸã‚ã«å¿…è¦
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRF-Token": csrfToken as string,
      },
    });
    const data = await res.json();
    console.log(data);
  };
  const getSession = async () => {
    const res = await fetch("http://localhost:3002/api/v1/session", {
      // sessionã‚„cookieã‚’ã‚»ãƒƒãƒˆã™ã‚‹ã‚ˆã†ãªå‡¦ç†ãªã‚‰å¿…è¦ã ãŒGETãƒ¡ã‚½ãƒƒãƒ‰ãªã®ã§åŸºæœ¬ä¸è¦
      credentials: "include",
      method: "GET",
      headers: {
        "Content-Type": "application/json",
      },
    });
    const data = await res.json();
    console.log(data);
  };

  const getUser = async () => {
    const res = await fetch("http://localhost:3002/api/v1/user", {
      credentials: "include",
      method: "GET",
      headers: {
        "Content-Type": "application/json",
      },
    });
    const data = await res.json();
    setUser(data.user);
  };

  const signup = async (formData: Iterable<readonly [PropertyKey, any]>) => {
    try {
      const res = await fetch("http://localhost:3002/api/v1/signup", {
        credentials: "include",
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRF-Token": csrfToken as string,
        },
        body: JSON.stringify({ user: Object.fromEntries(formData) }),
      });
      const data = await res.json();
      setUser(data.user);
    } catch (error) {
      console.error(error);
    }
  };

  const login = async (formData: Iterable<readonly [PropertyKey, any]>) => {
    try {
      const res = await fetch("http://localhost:3002/api/v1/login", {
        credentials: "include",
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRF-Token": csrfToken as string,
        },
        body: JSON.stringify({ session: Object.fromEntries(formData) }),
      });
      const data = await res.json();
      setUser(data.user);
    } catch (error) {
      console.error(error);
    }
  };

  const logout = async () => {
    try {
      const res = await fetch("http://localhost:3002/api/v1/logout", {
        credentials: "include",
        method: "DELETE",
        headers: {
          "Content-Type": "application/json",
          "X-CSRF-Token": csrfToken as string,
        },
      });
      const data = await res.json();
      if (res.ok) {
        setUser(null);
      }
    } catch (error) {
      console.error(error);
    }
  };

  async function handleSignup(e: FormEvent<HTMLFormElement>) {
    e.preventDefault();
    const formData = new FormData(e.currentTarget);
    await signup(formData);
    if (signupFormRef.current) {
      signupFormRef.current.reset();
    }
  }

  async function handleLogin(e: FormEvent<HTMLFormElement>) {
    e.preventDefault();
    const formData = new FormData(e.currentTarget);
    await login(formData);
    if (loginFormRef.current) {
      loginFormRef.current.reset();
    }
  }
```

ã“ã‚Œã§ã€ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚„ã€Cookieã‚’è¦‹ãªãŒã‚‰ã€ã„ã‚ã„ã‚è©¦ã—ã¦ã¿ã‚Œã°ç†è§£ã§ãã‚‹ã¨æ€ã„ã¾ã™ã€‚

1. CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç™ºè¡Œã›ãšã«ã€Cookieã‚’ã‚»ãƒƒãƒˆã€ä¼šå“¡ç™»éŒ²ã€ãƒ­ã‚°ã‚¤ãƒ³ã¯ã§ããªã„ãŒã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å–å¾—ãƒœã‚¿ãƒ³ã¯æŠ¼ã›ã‚‹ï¼ˆGETãƒ¡ã‚½ãƒƒãƒ‰ãªã®ã§ï¼‰
2. CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç™ºè¡Œã™ã‚‹ã“ã¨ã§ã€_session_idã¨ã„ã†CookieãŒã‚»ãƒƒãƒˆã•ã‚Œã‚‹
3. ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç™ºè¡Œã—ãŸçŠ¶æ…‹ã§ã‚ã‚Œã°ã€å…¨ã¦ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒã§ãã‚‹

## ã‚»ãƒƒã‚·ãƒ§ãƒ³å›ºå®šåŒ–æ”»æ’ƒå¯¾ç­–

ã¤ã„ã§ãªã®ã§ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³å›ºå®šåŒ–æ”»æ’ƒå¯¾ç­–ã‚‚ã—ã¦ãŠãã¾ã™ã€‚

ã‚»ãƒƒã‚·ãƒ§ãƒ³å›ºå®šåŒ–æ”»æ’ƒã¨ã¯ã€

1. session_idã‚’æ”»æ’ƒè€…ãŒç™ºè¡Œã—ã¦ã€javascriptã‚’ä½¿ã£ã¦`<script>document.cookie="_session_id=16d5b78abb28e3d6206b60f22a03c8d9";</script>`ã®ã‚ˆã†ã«ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®ãƒ–ãƒ©ã‚¦ã‚¶ã«ä»•è¾¼ã‚€ã€‚

2. ã“ã®çŠ¶æ…‹ã§ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãŒãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã¨ã€ãã®session_idã¯ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã¨ã„ã†ã“ã¨ã«ãªã‚‹ãŸã‚ã€æ”»æ’ƒè€…ã¯ãƒ­ã‚°ã‚¤ãƒ³ã«å¿…è¦ãªæƒ…å ±ã‚’å¾—ã‚‹ã“ã¨ãªãã€ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä¹—ã£å–ã‚‹ã“ã¨ãŒã§ãã¦ã—ã¾ã†ã€‚

ã¨ã„ã£ãŸå…·åˆã§ã™ã€‚ã“ã‚Œã¯ãƒ­ã‚°ã‚¤ãƒ³ã—ãŸã¨ãã«ã€session_idã‚’æ–°ã—ãæŒ¯ã‚Šç›´ã™ã“ã¨ã§é˜²ãã“ã¨ãŒã§ãã¾ã™ã€‚

ãã®ãŸã‚ã«ã¯ã€èªè¨¼å¾Œã«ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹å‡¦ç†ã‚’å…¥ã‚Œã¾ã™ã€‚

```diff ruby:app/controllers/api/v1/sessions_controller.rb
  def login
    @user = User.find_by(email: params[:session][:email].downcase)
    if @user&.authenticate(params[:session][:password])
+     reset_session
      session[:user_id] = @user.id
      render json: {user: @user}, status: :ok
    else
      render json: {error: @user.error}, status: :unprocessable_entity
    end
  end
```

ã“ã®1è¡Œã ã‘ã§ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³å›ºå®šåŒ–æ”»æ’ƒã®å¯¾ç­–ã«ãªã‚Šã¾ã™ã€‚

## ã¾ã¨ã‚

- Railsã§ã¯Sessionã¨Cookieã‚’æ‰±ã†ãŸã‚ã«è¨­å®šãŒå¿…è¦
- Railsã§Cookieã‚’å—ã‘å–ã‚‹è¨­å®šã€Next.jsã§Cookieã‚’é€ã‚‹è¨­å®šãŒå¿…è¦

## ä»Šå›ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰

@[card](https://github.com/makoto00000/cookie_practice)

## å‚è€ƒæ–‡çŒ®

- [å®‰å…¨ãªã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆã®ä½œã‚Šæ–¹ - 1.4 ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã®ä¸å‚™](https://www.ipa.go.jp/security/vuln/websecurity/session-management.html)
